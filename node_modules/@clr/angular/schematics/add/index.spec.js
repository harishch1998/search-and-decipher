"use strict";
/*
 * Copyright (c) 2016-2021 VMware, Inc. All Rights Reserved.
 * This software is released under MIT license.
 * The full license information can be found in LICENSE in the root directory of this project.
 */
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
const schematics_1 = require("@angular-devkit/schematics");
const testing_1 = require("@angular-devkit/schematics/testing");
const path_1 = require("path");
const _1 = require(".");
const get_file_content_1 = require("../utility/get-file-content");
const setup_project_1 = require("../utility/setup-project");
const PROJECT_NAME = 'foo';
const collectionPath = path_1.join(__dirname, '../collection.json');
describe('ng add @clr/angular', () => {
    it('should print an error if executed in an empty directory', () => __awaiter(void 0, void 0, void 0, function* () {
        const runner = new testing_1.SchematicTestRunner('schematics', collectionPath);
        try {
            yield runner.runSchematicAsync('ng-add', { module: 'app' }, schematics_1.Tree.empty()).toPromise();
            fail('expected to throw');
        }
        catch (e) {
            expect(e instanceof schematics_1.SchematicsException);
            expect(e.message).toEqual('Could not install Clarity, requires Angular and Angular CLI version 6 or greater');
        }
    }));
    describe('in a new Angular workspace', () => __awaiter(void 0, void 0, void 0, function* () {
        let runner;
        let workspaceTree;
        beforeEach(() => __awaiter(void 0, void 0, void 0, function* () {
            runner = new testing_1.SchematicTestRunner('schematics', collectionPath);
            workspaceTree = yield setup_project_1.setupProject(new testing_1.UnitTestTree(new schematics_1.HostTree()), runner, PROJECT_NAME);
        }));
        it('should add dependencies to Clarity packages', () => __awaiter(void 0, void 0, void 0, function* () {
            const tree = yield runner.runSchematicAsync('ng-add', {}, workspaceTree).toPromise();
            const packageJsonPath = '/package.json';
            expect(tree.files).toContain(packageJsonPath);
            const { dependencies } = JSON.parse(get_file_content_1.getFileContent(tree, packageJsonPath));
            expect(dependencies).toBeDefined();
            expect(dependencies['@clr/angular']).toBeDefined();
            expect(dependencies['@clr/ui']).toBeDefined();
            expect(dependencies['@cds/core']).toBeDefined();
        }));
        it('should add Clarity assets in the configuration file', () => __awaiter(void 0, void 0, void 0, function* () {
            const tree = yield runner.runSchematicAsync('ng-add', {}, workspaceTree).toPromise();
            const configFilePath = '/angular.json';
            expect(tree.files).toContain(configFilePath);
            const configFile = JSON.parse(get_file_content_1.getFileContent(tree, configFilePath));
            const styles = configFile.projects[PROJECT_NAME].architect.build.options.styles;
            expect(styles.includes('node_modules/@clr/ui/clr-ui.min.css')).toBeTruthy();
        }));
        it('should add return Clarity version as correct', () => __awaiter(void 0, void 0, void 0, function* () {
            const correct = _1.getVersion('^12.0.0', '12.0.0-next.0');
            expect(correct).toEqual('12.0.0-next.0');
        }));
        it('should throw a not support message', () => __awaiter(void 0, void 0, void 0, function* () {
            try {
                _1.getVersion('^12.0.0', '13.0.0');
            }
            catch (e) {
                expect(e.message).toEqual(`Clarity 13 doesn't support Angular 12`);
            }
        }));
        it('should return Clarity version 5', () => __awaiter(void 0, void 0, void 0, function* () {
            const correct = _1.getVersion('^11.0.0', '12.0.0');
            expect(correct).toEqual('^5.0.0');
        }));
        it('should return Clarity version 4', () => __awaiter(void 0, void 0, void 0, function* () {
            const correct = _1.getVersion('^10.0.0', '12.0.0');
            expect(correct).toEqual('^4.0.0');
        }));
        it('should return Clarity version 3', () => __awaiter(void 0, void 0, void 0, function* () {
            const correct = _1.getVersion('^9.0.0', '12.0.0');
            expect(correct).toEqual('^3.0.0');
        }));
        it('should not add Clarity assets in the configuration file if they are already present', () => __awaiter(void 0, void 0, void 0, function* () {
            const configFilePath = '/angular.json';
            const configFile = JSON.parse(get_file_content_1.getFileContent(workspaceTree, configFilePath));
            const styles = configFile.projects[PROJECT_NAME].architect.build.options.styles || [];
            styles.push('node_modules/@clr/ui/clr-ui');
            configFile.projects[PROJECT_NAME].architect.build.options.styles = styles;
            workspaceTree.overwrite(configFilePath, JSON.stringify(configFile, null, 2));
            const tree = yield runner.runSchematicAsync('ng-add', {}, workspaceTree).toPromise();
            expect(tree.files).toContain(configFilePath);
            const updatedConfigFile = JSON.parse(get_file_content_1.getFileContent(tree, configFilePath));
            const updatedStyles = updatedConfigFile.projects[PROJECT_NAME].architect.build.options.styles;
            expect(updatedStyles.includes('node_modules/@clr/ui/clr-ui.min.css')).toBeFalsy();
            expect(updatedStyles.includes('node_modules/@clr/icons/clr-icons.min.css')).toBeFalsy();
        }));
        it('should import ClarityModule to the root module', () => __awaiter(void 0, void 0, void 0, function* () {
            const tree = yield runner.runSchematicAsync('ng-add', {}, workspaceTree).toPromise();
            const rootModulePath = '/src/app/app.module.ts';
            const content = get_file_content_1.getFileContent(tree, rootModulePath);
            expect(content).toMatch(/import { ClarityModule } from '@clr\/angular'/);
        }));
        it('should import BrowserAnimationsModule to the root module', () => __awaiter(void 0, void 0, void 0, function* () {
            const tree = yield runner.runSchematicAsync('ng-add', {}, workspaceTree).toPromise();
            const rootModulePath = '/src/app/app.module.ts';
            const content = get_file_content_1.getFileContent(tree, rootModulePath);
            expect(content).toMatch(/import { BrowserAnimationsModule } from '@angular\/platform-browser\/animations'/);
        }));
    }));
});
//# sourceMappingURL=index.spec.js.map